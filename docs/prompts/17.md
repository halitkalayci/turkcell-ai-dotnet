User: Bana keycloakta bir kullanıcı ekleme ve bu kullanıcı ile order-service'in GET isteğini yetki ile çalıştırabilme testini yapılacak adımları adım adım planla.

Şu formatta ver:

- Keycloak admin panele gir kullanıcı ekle (hangi client'a hangi rolleri içersin)
- JWT'i şu şekilde al, şuraya yaz....
.......

GitHub Copilot: Hızlıca güvenlik ve Keycloak dosyalarını tarayıp adımları netleştiriyorum.

Research Keycloak + auth requirements

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/infra/keycloak/turkcell-ai-realm.json)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/infra/keycloak/clients.json)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/docs/security/keycloak-setup.md)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/docs/security/gateway-policies.md)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/docs/security/permission-model.md)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/docs/security/token-strategy.md)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/docs/security/claims-consistency.md)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/src/Gateway/appsettings.json)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/src/Gateway/yarp.json)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/src/Gateway/Middleware/RequestSecurityMiddleware.cs)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/src/Gateway/Program.cs)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/src/OrderService/Controllers/OrdersController.cs)

Searched for regex `PolicyNames|OrdersRead|OrdersCreate|OrdersUpdateStatus`, 20 results

Searched for text `ClaimNames`, 8 results

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/src/TurkcellAI.Core/Application/Authorization/PolicyNames.cs)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/src/TurkcellAI.Core/Application/Authorization/ClaimNames.cs)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/src/OrderService/Program.cs)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/src/OrderService/appsettings.json)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/docs/openapi/orderservice-v1.yaml#1-1), lines 1 to 400

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/docker-compose.yml)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/infra/keycloak/import/turkcell-ai-realm.json)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/src/ProductService/Program.cs)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/src/OrderService/Properties/launchSettings.json)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/src/Gateway/Properties/launchSettings.json)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/.NET/turkcell-ai/src/OrderService/test-requests.http)

İstediğin yetki testini hazırlamak için adımları çıkarıyorum; önce kullanıcıyı ekle, sonra PKCE ile JWT al, en sonda gateway üzerinden OrderService GET’i çağıracağız.

- Keycloak admin panele gir kullanıcı ekle (hangi client’a hangi rolleri içersin)
  - Panel: http://localhost:8080 → Realm: turkcell-ai
  - Users → Add user: `username`, `email` doldur, ardından Credentials → Set password (Temporary: Off)
  - Role Mappings → Realm Roles → `orders:order:read` rolünü ekle (liste GET için yeterli)
  - Not: `gateway` client zaten Public ve Authorization Code (+PKCE) akışında; `permissions` claim’i için mapper aktif (bkz. turkcell-ai-realm.json, permission-model.md)

- JWT’i şu şekilde al, şuraya yaz
  - Yöntem: Authorization Code + PKCE (bkz. token-strategy.md)
  - Gerekli OAuth ayarları:
    - Authorization URL: http://localhost:8080/realms/turkcell-ai/protocol/openid-connect/auth
    - Token URL: http://localhost:8080/realms/turkcell-ai/protocol/openid-connect/token
    - Client ID: `gateway` (Public; secret yok)
    - PKCE: S256 challenge kullan
    - Scope: `openid` (realm rol mapper, `permissions` claim’ini otomatik ekler)
    - Redirect URI: İstersen Postman kullanacaksan `https://oauth.pstmn.io/v1/callback`’i `gateway` client → Settings → Valid Redirect URIs listesine ekle
  - Login sonrası `access_token`’ı al; içinde `permissions` claim’inde `orders:order:read` görmelisin

- Token’ı PowerShell ortam değişkenine koy
```powershell
$env:ACCESS_TOKEN = "<buraya_access_token_yapıştır>"
```

- Gateway üzerinden OrderService GET isteğini çalıştır
  - Gateway HTTP URL: http://localhost:8000 (bkz. yarp.json)
  - OrderService route: `/api/v1/orders` (bkz. orderservice-v1.yaml)
```powershell
curl -s -H "Authorization: Bearer $env:ACCESS_TOKEN" ^
  "http://localhost:8000/api/v1/orders?pageNumber=1&pageSize=20"
```

- Beklenen yetki ve doğrulama
  - OrderService GET, `permissions` içinde `orders:order:read` ister (bkz. orderservice-v1.yaml)
  - Yetki kontrolü servis tarafında policy ile yapılır; gateway sadece doğrular (bkz. RequestSecurityMiddleware.cs)

- Hata alırsan kontrol et
  - 401: Token yok/yanlış issuer (Authority: http://localhost:8080/realms/turkcell-ai)
  - 403: JWT’de `permissions` içinde `orders:order:read` yok; kullanıcıya doğru rolü ata
  - JWT’yi jwt.io ile açıp `permissions` claim’ini doğrula

- Alternatif: Servis-to-servis test (Client Credentials)
  - `orderservice` client (Confidential) için service account’a `orders:order:read` rolünü ver
```powershell
$token = (curl -s -X POST `
  -d "client_id=orderservice" `
  -d "client_secret=changeme-orderservice" `
  -d "grant_type=client_credentials" `
  http://localhost:8080/realms/turkcell-ai/protocol/openid-connect/token | ConvertFrom-Json).access_token
curl -s -H "Authorization: Bearer $token" "http://localhost:8000/api/v1/orders?pageNumber=1&pageSize=20"
```

- Çalıştırmadan önce
  - Docker ile keycloak/gateway/services ayakta olmalı (bkz. docker-compose.yml)
  - Gateway ve OrderService appsettings dev ayarları hazır (bkz. appsettings.json, appsettings.json)

İstersen Postman/Bruno için PKCE ayar ekranındaki alanları tek tek doldurman için kısa bir checklist de çıkarabilirim.